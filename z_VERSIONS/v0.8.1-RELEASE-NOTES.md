# Lightroom Meta Tagger v0.8.1 - Release Notes

**Release Date:** October 28, 2024

## 🎉 What's New

### ✨ Major Bug Fixes

#### 1. **Fixed "Make Parent Image" Button for 0% Similarity** 🔧
- **Issue**: Button disappeared for images with 0% similarity
- **Root Cause**: JavaScript truthiness bug - `0` is falsy, so button logic failed
- **Solution**: Use explicit `null`/`undefined` checks instead of truthiness
- **Impact**: Button now appears for ALL similarity values (0-100%)

#### 2. **Fixed Preview Loading Order** 🖼️
- **Issue**: Button wouldn't show when preview images failed to load
- **Root Cause**: Function exited early with alert before button logic ran
- **Solution**: Moved button logic before preview loading attempt
- **Bonus**: Added placeholder SVG for failed previews (no more blocking alerts)

#### 3. **Fixed Portrait Image Rotation** 📸
- **Issue**: Old Canon CR2 files with "Old-style JPEG compression" displayed sideways
- **Root Cause**: Sharp couldn't handle old CR2 compression format
- **Solution**: Exiftool-first approach:
  1. Extract preview with exiftool (handles old CR2 files)
  2. Save to temp file
  3. Read EXIF Orientation from RAW
  4. Process with Sharp (resize + rotate)
  5. Clean up temp file

#### 4. **Fixed GPS Location Data** 🗺️
- **Issue**: Location fields empty despite GPS coordinates
- **Root Cause**: Ollama returns nested `location` object, code expected flat properties
- **Solution**: Handle both nested and flat data structures in UI
- **Impact**: Location data now displays correctly in metadata editor

#### 5. **Enhanced GPS Location Processing** 🌍
- **Improvement**: AI now actively uses GPS coordinates to determine location
- **Changes**: Updated prompts in `aiAnalysisService.js` and `main.js`
- **Result**: Better location accuracy when GPS coordinates are available

### 🎨 UI/UX Improvements

#### **Icon Support** 🖼️
- Added Lightroom icon to Electron app
- Icon now displays in:
  - macOS Dock
  - Window title bar
  - System dialogs
- Icon path: `icon/Lightroom ICON.png`

#### **XMP Generation** 📄
- Removed blocking alert popups
- Shows progress and results inline under button
- Better visual feedback during generation
- Displays count of generated XMP files

#### **Google Maps Integration** 🗺️
- Fixed external link handling via IPC
- Uses proper Google Maps API URL format
- Opens in default browser securely

### 🔧 Technical Improvements

#### **Code Quality**
- Fixed all JavaScript syntax errors
- Removed legacy code and dead functions
- Improved error handling throughout
- Better debug logging

#### **Preview Processing**
- Exiftool integration for old Canon CR2 files
- Automatic EXIF orientation handling
- Better fallback mechanisms
- Proper temp file cleanup

#### **Data Structure Consistency**
- Unified location data format (nested object)
- Better GPS data flow
- Improved metadata editor
- Consistent data handling across app

### 📋 Files Modified

**Core Files:**
- `src/renderer/app.js` - Major bug fixes and UI improvements
- `src/services/imageProcessor.js` - Exiftool-first preview extraction
- `src/services/aiAnalysisService.js` - Enhanced GPS location prompts
- `src/main/main.js` - Icon configuration and GPS prompt improvements
- `src/renderer/index.html` - UI updates for XMP results

**Configuration:**
- `icon/Lightroom ICON.png` - App icon added

### 🐛 Known Issues

- Some very old Canon CR2 files may still fail preview generation
- Large image collections may take time to process
- CLIP service requires Python environment setup

### 🚀 How to Use

1. **Start the app**: `npm start`
2. **Drag and drop** your image folder
3. **Edit metadata** on the Visual Analysis tab
4. **Run AI Analysis** to generate metadata
5. **Review and edit** AI-generated results
6. **Generate XMP** files for Lightroom import

### 📝 Installation Notes

- Requires Node.js and npm
- Python 3.9+ for CLIP similarity service
- Exiftool must be installed
- Optional: dcraw for old CR2 files

### 🔄 Upgrade Notes

If upgrading from v0.7 or earlier:
- Clear `temp/` directory for fresh preview generation
- Review GPS location data structure changes
- Test "Make Parent Image" button functionality
- Verify icon displays correctly

## 🙏 Acknowledgments

Special thanks for debugging assistance with complex RAW file handling and JavaScript truthiness issues.

---

**Version:** 0.8.1  
**Build:** c0173d6  
**Status:** Stable Release

